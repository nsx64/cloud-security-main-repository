## Azure Blob Storage Security Misconfiguration Exploit

### Overview

Azure Blob Storage provides extensive capabilities, including robust security features. However, the responsibility of securing data ultimately falls on the account owner.

There have been numerous cases where data breaches occurred due to misconfigured public Azure Blob Storage, leading to unintended data exposure.

This lab conceptually demonstrates how such a misconfiguration can be exploited in a specific scenario.

---

## Attack Demonstration

### Step 1: Identifying Blob Storage Usage

We begin by examining the target website and its source code:

![blob-service](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/blob-service.png)

From our investigation, we determine that static web files are hosted on Azure Blob Storage:

**Example URL Structure:**

```
blob.core.windows.net
```

#### What is Azure Blob Storage?

According to Microsoft:

> "Azure Blob Storage is Microsoft's object storage solution for the cloud, optimized for storing massive amounts of unstructured data such as text or binary files."

**Common Use Cases:**

- Serving images or documents directly to a browser
- Storing files for distributed access
- Streaming video and audio
- Writing log files
- Backup, restore, disaster recovery, and archiving
- Data analysis by on-premises or Azure-hosted services

### Step 2: Enumerating Web Resources

We enumerate the storage container using `Invoke-WebRequest`:

```
https://mbtwebsite.blob.core.windows.net/$web/index.html
```

![web-srv-response-headers 1.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/web-srv-response-headers.png) 

The response confirms the presence of Azure Blob Storage hosting web files. Expanding the headers reveals further details:

![web-srv-response-headers-expandproperty 1.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/web-srv-response-headers-expandproperty.png)

**Information Revealed:**

- Server type
- Blob type
- Last modified date

To further analyze, we verify the `$web` container:

![blob-web-container.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/blob-web-container.png)

Interestingly, an XML document is returned, indicating potential directory listings. We further enumerate using a delimiter (`%2F`):

![dir-enum-delimiter 1.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/dir-enum-delimiter.png)

### Step 3: Exploiting Blob Versioning

#### What is Blob Versioning?

According to Microsoft:

> "Blob storage versioning allows automatic maintenance of previous versions of an object. When enabled, earlier versions can be accessed to recover modified or deleted data."

This means that sensitive data (e.g., hardcoded credentials) might still be retrievable from previously uploaded files.

We attempt enumeration via the browser but find it unsuccessful:

![[list-version-browser.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/list-version-browser.png)

![list-version-browser unsuccessful.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/list-version-browser%20unsuccessful.png)

Using the command line, we extract versioning details:

```
curl -H "x-ms-version: 2019-12-12" 'https://mbtwebsite.blob.core.windows.net/$web?restype=container&comp=list&include=versions' | xmllint --format - | less
```

Note: The `x-ms-version` header is set to `2019-12-12` since versioning is only supported in versions from December 2019 and later.

![ms-versions-1](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/ms-doc-versioning-2.png) 
![ms-versions-2](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/ms-doc-versioning-2.png)

The output reveals a blob file `scripts-transfer.zip` along with its version ID:

![blob-versions-xml-cli.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/blob-versions-xml-cli.png)

We then proceed to download the file:

![downloading-script-transfer-file.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/downloading-script-transfer-file.png)

Upon extraction, we find hardcoded sensitive data in plaintext.

---

## Prevention and Defense

### Issue #1: Publicly Accessible Blob Container

The primary issue is that the entire blob container is configured for anonymous, world-readable access. Instead, only specific website files should be publicly accessible.

![world-readable-anonymous-user-access-enabled-defense.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/world-readable-anonymous-user-access-enabled-defense.png)

### Issue #2: Unsecured Blob Versioning

A previous version of a sensitive file was publicly accessible. To mitigate this risk, sensitive versions should be permanently deleted.

![deleting-previous-blob-version-defense.png](https://github.com/nsx64/pentesting-and-security-projects/blob/main/Azure%20Pentesting/Azure%20Blob%20Storage%20Security%20Misconfiguration%20Exploit/images/deleting-previous-blob-version-defense.png)

### Key Takeaways

This attack could have been easily prevented by implementing basic security best practices:

- **Follow the principle of least privilege:** Restrict public access only to necessary resources.
- **Enable proper access controls:** Use SAS tokens, managed identities, or private endpoints.
- **Regularly audit and monitor storage configurations:** Utilize Azure Security Center to identify misconfigurations.
- **Delete outdated and sensitive versions of files:** Prevent unauthorized access to sensitive information.

By adhering to these security practices, organizations can significantly reduce the risk of unintended data exposure in Azure Blob Storage.
